<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Operations Gist — Sticky Summary</title>
<style>
/* ═══════════════════════════════════════════════════════════
   GRAFANA BUSINESS TEXT COMPATIBLE — NO CSS CUSTOM PROPERTIES
   Ultra-compact sticky gist panel — <20% screen width (~280px)
   Purely business insights, collapsible categories
   ═══════════════════════════════════════════════════════════ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

.gp {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: #ffffff;
  color: #1e293b;
  width: 280px;
  max-height: 100vh;
  overflow-y: auto;
  font-size: 11px;
  line-height: 1.4;
  border-right: 1px solid #e2e8f0;
  -webkit-font-smoothing: antialiased;
  position: sticky;
  top: 0;
}

/* ── Scrollbar ──────────────────────────────────── */
.gp::-webkit-scrollbar { width: 3px; }
.gp::-webkit-scrollbar-track { background: transparent; }
.gp::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* ── Health Banner (always visible, pinned) ─────── */
.gp-banner {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #ffffff;
  padding: 8px 12px;
  border-bottom: 1px solid #e2e8f0;
}
.gp-banner-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.gp-status {
  display: flex;
  align-items: center;
  gap: 7px;
}
.gp-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.gp-dot.r { background: #dc2626; box-shadow: 0 0 0 2px #fef2f2; }
.gp-dot.y { background: #d97706; box-shadow: 0 0 0 2px #fffbeb; }
.gp-dot.g { background: #059669; box-shadow: 0 0 0 2px #ecfdf5; }
.gp-title {
  font-size: 12px; font-weight: 700; letter-spacing: -0.01em;
}
.gp-pills { display: flex; gap: 4px; }
.gp-p {
  font-size: 9px; font-weight: 800; padding: 2px 5px; border-radius: 8px;
}
.gp-p.r { background: #fef2f2; color: #991b1b; }
.gp-p.y { background: #fffbeb; color: #92400e; }
.gp-p.g { background: #ecfdf5; color: #065f46; }
.gp-sub {
  font-size: 9px; color: #94a3b8; margin-top: 3px;
}

/* ── Category Section ───────────────────────────── */
.gp-cat {
  border-bottom: 1px solid #f1f5f9;
}

/* Category header — clickable toggle */
.gp-ch {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 7px 12px;
  cursor: pointer;
  user-select: none;
  transition: background 0.12s;
}
.gp-ch:hover { background: #f8fafc; }
.gp-ch-left {
  display: flex;
  align-items: center;
  gap: 6px;
  min-width: 0;
}
.gp-ch-arrow {
  font-size: 8px;
  color: #94a3b8;
  transition: transform 0.2s;
  flex-shrink: 0;
  width: 10px;
  text-align: center;
  display: inline-block;
}
.gp-cat.open .gp-ch-arrow { transform: rotate(90deg); }
.gp-ch-name {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: #475569;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.gp-ch-right {
  display: flex; align-items: center; gap: 5px; flex-shrink: 0;
}
.gp-badge {
  font-size: 8px; font-weight: 800; padding: 1px 6px; border-radius: 6px;
  letter-spacing: 0.02em; text-transform: uppercase;
}
.gp-badge.r { background: #fef2f2; color: #991b1b; }
.gp-badge.y { background: #fffbeb; color: #92400e; }
.gp-badge.g { background: #ecfdf5; color: #065f46; }
.gp-ch-count {
  font-size: 8px; color: #94a3b8; font-weight: 600;
}

/* Category insight (always visible, below header) */
.gp-insight {
  padding: 0 12px 6px 28px;
  font-size: 10px;
  line-height: 1.4;
  color: #475569;
}
.gp-insight strong { color: #1e293b; font-weight: 600; }
.gp-insight .hi { font-weight: 700; }
.gp-insight .hi.r { color: #dc2626; }
.gp-insight .hi.y { color: #b45309; }
.gp-insight .hi.g { color: #059669; }

/* Category body — expand/collapse */
.gp-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.25s ease;
}
.gp-cat.open .gp-body {
  max-height: 800px;
}

/* Metric row inside expanded body */
.gp-row {
  display: grid;
  grid-template-columns: 6px 1fr auto 32px;
  gap: 5px;
  align-items: center;
  padding: 4px 12px 4px 28px;
}
.gp-row:hover { background: #f8fafc; }
.gp-rd {
  width: 6px; height: 6px; border-radius: 50%;
}
.gp-rd.r { background: #dc2626; }
.gp-rd.y { background: #d97706; }
.gp-rd.g { background: #16a34a; }
.gp-rn {
  font-size: 10px; font-weight: 600; color: #334155;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.gp-rv {
  font-size: 10px; font-weight: 700; text-align: right;
  font-variant-numeric: tabular-nums;
}
.gp-rv.r { color: #dc2626; }
.gp-rv.y { color: #b45309; }
.gp-rv.g { color: #334155; }
.gp-sp svg { width: 32px; height: 12px; }

/* Breach micro-tag */
.gp-bt {
  display: inline-block;
  font-size: 7px; font-weight: 800; padding: 0 3px; border-radius: 2px;
  margin-left: 3px; vertical-align: middle; letter-spacing: 0.02em;
}
.gp-bt.br { background: #dc2626; color: #fff; }
.gp-bt.im { background: #fef2f2; color: #991b1b; }
.gp-bt.pj { background: #fffbeb; color: #92400e; }

/* In-category action recommendation */
.gp-bact {
  padding: 4px 12px 6px 28px;
  font-size: 9px;
  color: #475569;
  line-height: 1.4;
  border-top: 1px dashed #e2e8f0;
  margin-top: 2px;
}
.gp-bact .gp-urg {
  display: inline-block;
  font-weight: 800;
  font-size: 8px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  padding: 1px 4px;
  border-radius: 3px;
  margin-right: 4px;
  vertical-align: middle;
}
.gp-bact .gp-urg.urgent  { background: #dc2626; color: #fff; }
.gp-bact .gp-urg.moderate { background: #d97706; color: #fff; }

/* ── Footer ────────────────────────────────────── */
.gp-foot {
  padding: 5px 12px;
  font-size: 8px;
  color: #94a3b8;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid #e2e8f0;
}
.gp-tags { display: flex; gap: 3px; }
.gp-tag {
  padding: 1px 4px; border-radius: 2px; font-weight: 700;
}
.gp-tag.a { background: #eff6ff; color: #1d4ed8; }
.gp-tag.b { background: #fef3c7; color: #92400e; }
.gp-tag.c { background: #ede9fe; color: #5b21b6; }
.gp-tag.d { background: #ecfdf5; color: #065f46; }

/* Pulsing dot for critical */
@keyframes gpp {
  0%,100% { opacity:1; }
  50% { opacity:0.4; }
}
.gp-dot.r { animation: gpp 2s ease-in-out infinite; }
</style>
</head>
<body style="background:#f1f5f9; display:flex; gap:0; min-height:100vh;">

<!-- ═══ THE STICKY PANEL ═══ Paste CSS + div#gp + JS into Grafana Business Text -->
<div class="gp" id="gp"></div>

<!-- Demo placeholder for the rest of the Grafana dashboard -->
<div style="flex:1; padding:40px; color:#64748b; font-family:Inter,sans-serif;">
  <div style="background:#fff; border-radius:12px; padding:32px; box-shadow:0 1px 3px rgba(0,0,0,0.05); max-width:640px;">
    <h2 style="font-size:16px; margin-bottom:8px; color:#1e293b;">Main Dashboard Area (80%+ of screen)</h2>
    <p style="font-size:13px; line-height:1.6;">The gist panel on the left takes <strong>280px</strong> — that's <strong>14.6%</strong> of a 1920px display. It stays sticky as you scroll.</p>
    <ul style="font-size:12px; margin-top:12px; padding-left:20px; line-height:1.8; color:#475569;">
      <li>Categories <strong>auto-expand</strong> when they have issues; collapse when healthy</li>
      <li>Click any category header to manually expand/collapse</li>
      <li>Business insights update in plain English — no technical jargon</li>
      <li>Each category shows a single recommended action when needed</li>
    </ul>
  </div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════
   DATA — 14 metrics, 4 categories
   ═══════════════════════════════════════════════════════════ */
const M = [
  {id:'np1',nm:'Port Group 1',sh:'Grp 1',cat:'Nuance Telephony',tp:'cap',dr:'hi',cap:500,v:472,h:[310,325,318,340,335,328,342,350,355,360,368,375,380,390,398,410,425,440,458,472]},
  {id:'np2',nm:'Port Group 2',sh:'Grp 2',cat:'Nuance Telephony',tp:'cap',dr:'hi',cap:400,v:312,h:[220,228,235,230,240,245,250,248,255,260,262,268,274,278,282,288,292,298,305,312]},
  {id:'np3',nm:'Port Group 3',sh:'Grp 3',cat:'Nuance Telephony',tp:'cap',dr:'hi',cap:300,v:185,h:[150,155,148,160,158,162,165,170,168,172,175,178,174,176,180,178,182,180,183,185]},
  {id:'ss1',nm:'Server 1',sh:'Srv 1',cat:'Self Service',tp:'ratio',dr:'lo',v:.58,h:[.73,.72,.74,.71,.73,.72,.70,.71,.69,.68,.67,.66,.65,.64,.63,.62,.61,.60,.59,.58]},
  {id:'ss2',nm:'Server 2',sh:'Srv 2',cat:'Self Service',tp:'ratio',dr:'lo',v:.71,h:[.75,.74,.76,.73,.75,.74,.73,.74,.73,.72,.73,.72,.72,.71,.72,.71,.71,.72,.71,.71]},
  {id:'ss3',nm:'Server 3',sh:'Srv 3',cat:'Self Service',tp:'ratio',dr:'lo',v:.67,h:[.80,.79,.78,.77,.78,.76,.75,.74,.73,.72,.71,.72,.71,.70,.70,.69,.68,.68,.67,.67]},
  {id:'a1',nm:'CRM Service',sh:'CRM',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.78,h:[.93,.92,.94,.91,.93,.90,.92,.91,.89,.90,.88,.87,.86,.85,.84,.83,.82,.80,.79,.78]},
  {id:'a2',nm:'Auth Service',sh:'Auth',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.91,h:[.95,.94,.95,.94,.93,.94,.93,.93,.94,.93,.92,.93,.92,.92,.92,.91,.92,.91,.91,.91]},
  {id:'a3',nm:'Payment Gateway',sh:'Payment',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.84,h:[.96,.95,.94,.93,.94,.93,.92,.91,.92,.91,.90,.89,.88,.87,.88,.87,.86,.85,.85,.84]},
  {id:'a4',nm:'Search API',sh:'Search',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.92,h:[.94,.93,.94,.93,.93,.93,.94,.93,.93,.93,.92,.93,.92,.93,.92,.92,.93,.92,.92,.92]},
  {id:'a5',nm:'Unified Gateway',sh:'UGW',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.88,h:[.96,.95,.96,.94,.95,.94,.93,.94,.93,.92,.93,.92,.91,.92,.91,.90,.90,.89,.89,.88]},
  {id:'a6',nm:'Notification Svc',sh:'Notify',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.86,h:[.94,.93,.92,.93,.92,.91,.92,.91,.90,.90,.89,.89,.88,.88,.87,.87,.87,.86,.86,.86]},
  {id:'a7',nm:'Reporting Engine',sh:'Reports',cat:'App Health (.NET)',tp:'ratio',dr:'lo',v:.89,h:[.92,.93,.92,.91,.92,.91,.91,.90,.91,.90,.90,.90,.89,.90,.89,.89,.90,.89,.89,.89]},
  {id:'rp',nm:'Call Requests/Min',sh:'RPM',cat:'Genesys Calls',tp:'count',dr:'both',v:1850,h:[1180,1210,1195,1220,1205,1215,1230,1190,1225,1240,1200,1235,1250,1260,1310,1400,1520,1650,1780,1850]}
];

const SC=3.09, SE=2.33;

/* ── Stats engine (compact) ─────────────────────── */
const lg=p=>{const c=Math.max(.001,Math.min(.999,p));return Math.log(c/(1-c));};
const mn=a=>a.reduce((s,v)=>s+v,0)/a.length;
const sd=a=>{const m=mn(a);return Math.sqrt(a.reduce((s,v)=>s+(v-m)**2,0)/(a.length-1));};
const md=a=>{const s=[...a].sort((x,y)=>x-y),m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;};
const ma=a=>{const m=md(a);return md(a.map(v=>Math.abs(v-m)));};

function tr(a){
  const n=a.length,xm=(n-1)/2,ym=mn(a);let nm=0,dn=0,tt=0;
  for(let i=0;i<n;i++){nm+=(i-xm)*(a[i]-ym);dn+=(i-xm)**2;tt+=(a[i]-ym)**2;}
  const sl=dn>0?nm/dn:0,rs=a.reduce((s,y,i)=>s+(y-(ym+sl*(i-xm)))**2,0);
  return{sl,r2:tt>0?1-rs/tt:0};
}
function hwf(d){
  const n=d.length,al=.3,bt=.1;if(n<3)return{lv:d[n-1],t:0};
  let lv=d[0],t=(d[Math.min(2,n-1)]-d[0])/Math.min(2,n-1);
  for(let i=1;i<n;i++){const pL=lv,pT=t;lv=al*d[i]+(1-al)*(pL+pT);t=bt*(lv-pL)+(1-bt)*pT;}
  return{lv,t};
}
function brch(m,hw,bl){
  let th;
  if(m.tp==='ratio'&&m.dr==='lo')th=.70;
  else if(m.tp==='ratio')th=.95;
  else if(m.tp==='cap')th=m.cap*.95;
  else th=md(bl)*2;
  let pr=null;
  for(let i=1;i<=50;i++){const v=hw.lv+i*hw.t;if(m.dr==='lo'?v<th:v>th){pr=i;break;}}
  return{pr,th,br:m.dr==='lo'?m.v<th:m.v>th};
}

function run(m){
  const bE=Math.floor(m.h.length*.7),bl=m.h.slice(0,bE);
  let z;
  if(m.tp==='ratio'){const t=bl.map(lg),u=mn(t),s=sd(t);z=s>0?(lg(m.v)-u)/s:0;}
  else if(m.tp==='cap'){const t=bl.map(v=>lg(v/m.cap)),u=mn(t),s=sd(t);z=s>0?(lg(m.v/m.cap)-u)/s:0;}
  else{const d=md(bl),a=1.4826*ma(bl);z=a>0?(m.v-d)/a:0;}
  if(m.dr==='lo')z=-z;else if(m.dr==='both')z=Math.abs(z);
  const az=Math.abs(z),rk=az>SC?'r':az>SE?'y':'g';
  const t=tr(m.h),hw=hwf(m.h),b=brch(m,hw,bl);
  return{z,az,rk,tr:t,hw,br:b};
}

/* ── Business Insight Generator ─────────────────── */
function insight(cat,items){
  const crs=items.filter(i=>i.a.rk==='r'), wrs=items.filter(i=>i.a.rk==='y');
  const brd=items.filter(i=>i.a.br.br);
  const near=items.filter(i=>!i.a.br.br&&i.a.br.pr&&i.a.br.pr<=5);
  const decl=items.filter(i=>i.a.tr.sl<0&&i.a.tr.r2>.5&&i.m.dr==='lo');
  const risg=items.filter(i=>i.a.tr.sl>0&&i.a.tr.r2>.5&&i.m.dr==='hi');

  if(cat==='Nuance Telephony'){
    if(brd.length) return '<span class="hi r">Call capacity exceeded</span> on '+brd.map(i=>i.m.sh).join(', ')+'. Customers may get busy signals or dropped calls.';
    if(near.length) return '<span class="hi y">Capacity limit approaching</span> on '+near.map(i=>i.m.sh).join(', ')+'. Expected to reach limit in ~'+Math.min(...near.map(i=>i.a.br.pr))+' periods.';
    if(risg.length) return 'Port usage <strong>steadily climbing</strong> on '+risg.map(i=>i.m.sh).join(', ')+'. Plan capacity expansion soon.';
    if(crs.length) return '<span class="hi r">Unusually high</span> port consumption. Risk of call routing issues.';
    if(wrs.length) return '<span class="hi y">Above-average</span> usage. Watch peak-hour pressure.';
    return '<span class="hi g">Healthy.</span> All port groups within normal range.';
  }
  if(cat==='Self Service'){
    if(brd.length) return '<span class="hi r">Below acceptable</span> on '+brd.map(i=>i.m.sh).join(', ')+'. More callers reaching live agents — expect longer wait times.';
    if(crs.length) return '<span class="hi r">Containment dropping fast</span> on '+crs.map(i=>i.m.sh).join(', ')+'. ~200 extra agent calls per 1% drop.';
    if(decl.length) return '<span class="hi y">Downward trend</span> on '+decl.map(i=>i.m.sh).join(', ')+'. IVR or knowledge base may need refresh.';
    if(wrs.length) return '<span class="hi y">Below target</span> on '+wrs.map(i=>i.m.sh).join(', ')+'. Agent workload may increase.';
    return '<span class="hi g">On target.</span> Self-service absorbing calls well.';
  }
  if(cat==='App Health (.NET)'){
    if(brd.length) return '<span class="hi r">User experience degraded</span> on '+brd.map(i=>i.m.sh).join(', ')+'. Slow response times for customers and agents.';
    if(crs.length) return '<span class="hi r">Performance critically low</span> on '+crs.map(i=>i.m.sh).join(', ')+'. Agent tools and portals affected.';
    if(decl.length>=3) return '<span class="hi y">Widespread slowdown</span> across '+decl.length+' services ('+decl.map(i=>i.m.sh).join(', ')+'). Possible infrastructure issue.';
    if(decl.length) return '<span class="hi y">Performance declining</span> on '+decl.map(i=>i.m.sh).join(', ')+'. Investigate before SLA impact.';
    if(wrs.length) return '<span class="hi y">Slightly degraded</span> on '+wrs.map(i=>i.m.sh).join(', ')+'. Monitor closely.';
    return '<span class="hi g">All healthy.</span> Response times within SLA.';
  }
  if(cat==='Genesys Calls'){
    const r=items[0]; if(!r) return '';
    if(r.a.br.br) return '<span class="hi r">Call volume surging</span> — 2× above normal. Check for outage spikes or campaigns.';
    if(r.a.rk==='r'&&r.a.tr.sl>0) return '<span class="hi r">Rapid call growth</span> — well above baseline and still climbing.';
    if(r.a.rk==='r'&&r.a.tr.sl<0) return '<span class="hi r">Unusual volume drop</span> — possible routing failure or outage.';
    if(r.a.rk==='y') return '<span class="hi y">Above normal.</span> Correlate with business events.';
    if(r.a.tr.sl>0&&r.a.tr.r2>.5) return 'Volume <strong>trending up</strong> gradually. Organic growth.';
    return '<span class="hi g">Normal.</span> Call volume within expected range.';
  }
  return '';
}

/* ── Category-level top action ──────────────────── */
function catAct(cat,items){
  const urg=items.filter(i=>i.a.rk==='r'||i.a.br.br||(i.a.br.pr&&i.a.br.pr<=5));
  const mod=items.filter(i=>i.a.rk==='y'||(i.a.tr.r2>.5&&i.a.rk!=='g'&&((i.m.dr==='lo'&&i.a.tr.sl<0)||(i.m.dr==='hi'&&i.a.tr.sl>0))));

  if(cat==='Nuance Telephony'){
    if(urg.length) return {u:'urgent',t:'Contact Nuance for emergency capacity expansion on '+urg.map(i=>i.m.sh).join(', ')+'. Call drop risk is imminent.'};
    if(mod.length) return {u:'moderate',t:'Set 85% utilization alerts and review peak-hour patterns for '+mod.map(i=>i.m.sh).join(', ')+'.'};
    return null;
  }
  if(cat==='Self Service'){
    if(urg.length) return {u:'urgent',t:'Audit IVR flows and knowledge base on '+urg.map(i=>i.m.sh).join(', ')+'. Alert workforce management — agent demand rising.'};
    if(mod.length) return {u:'moderate',t:'Review top call drivers and update self-service content for '+mod.map(i=>i.m.sh).join(', ')+'.'};
    return null;
  }
  if(cat==='App Health (.NET)'){
    if(urg.length) return {u:'urgent',t:'Escalate '+urg.map(i=>i.m.sh).join(', ')+' to platform team. Customer and agent experience impacted.'};
    if(mod.length) return {u:'moderate',t:'Review recent releases and run performance profiling on '+mod.map(i=>i.m.sh).join(', ')+'.'};
    return null;
  }
  if(cat==='Genesys Calls'){
    const r=items[0]; if(!r) return null;
    if(r.a.rk==='r'&&r.a.tr.sl>0) return {u:'urgent',t:'Rule out bot/DDoS traffic. Verify rate limiters. Alert NOC.'};
    if(r.a.rk==='r'&&r.a.tr.sl<0) return {u:'urgent',t:'Check load balancer and DNS health. Possible customer outage.'};
    if(r.a.rk==='y') return {u:'moderate',t:'Correlate volume with marketing campaigns and seasonal patterns.'};
    return null;
  }
  return null;
}

/* ── Format helpers ─────────────────────────────── */
function fv(m){
  if(m.tp==='ratio')return(m.v*100).toFixed(1)+'%';
  if(m.tp==='cap')return Math.round(m.v)+'/'+m.cap;
  return Math.round(m.v).toLocaleString();
}
function spark(h,c){
  const W=32,H=12,lo=Math.min(...h),hi=Math.max(...h),rg=hi-lo||1;
  const pts=h.map((v,i)=>(i/(h.length-1))*W+','+(H-1-((v-lo)/rg)*(H-2)));
  const cl=c==='r'?'#dc2626':c==='y'?'#d97706':'#64748b';
  return '<svg viewBox="0 0 '+W+' '+H+'"><polyline points="'+pts.join(' ')+'" fill="none" stroke="'+cl+'" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>';
}

/* ═══════════════════════════════════════════════════════════
   RENDER
   ═══════════════════════════════════════════════════════════ */
function render(){
  const p=document.getElementById('gp');
  const all=M.map(m=>({m,a:run(m)}));
  const cr=all.filter(r=>r.a.rk==='r').length;
  const wr=all.filter(r=>r.a.rk==='y').length;
  const ok=all.length-cr-wr;
  const oc=cr?'r':wr?'y':'g';
  const ol=cr?'Critical':wr?'Elevated':'All Clear';
  const os=(cr+wr)?(cr+wr)+'/'+all.length+' need attention':'All '+all.length+' healthy';
  const now=new Date();
  const ts=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})+' · '+now.toLocaleDateString('en-US',{month:'short',day:'numeric'});

  // Group by category
  const cats={}; all.forEach(r=>{if(!cats[r.m.cat])cats[r.m.cat]=[];cats[r.m.cat].push(r);});
  const order=['Nuance Telephony','Self Service','App Health (.NET)','Genesys Calls'];

  let o='';

  // Banner
  o+='<div class="gp-banner">';
  o+='<div class="gp-banner-row">';
  o+='<div class="gp-status"><div class="gp-dot '+oc+'"></div><span class="gp-title">'+ol+'</span></div>';
  o+='<div class="gp-pills"><span class="gp-p r">'+cr+'</span><span class="gp-p y">'+wr+'</span><span class="gp-p g">'+ok+'</span></div>';
  o+='</div>';
  o+='<div class="gp-sub">'+os+' · '+ts+'</div>';
  o+='</div>';

  // Categories
  order.forEach((cat,ci)=>{
    const arr=cats[cat]; if(!arr) return;
    const worst=arr.some(r=>r.a.rk==='r')?'r':arr.some(r=>r.a.rk==='y')?'y':'g';
    // Auto-open categories with issues; healthy ones start collapsed
    const open=worst!=='g';

    o+='<div class="gp-cat'+(open?' open':'')+'" data-c="'+ci+'">';

    // Clickable header
    o+='<div class="gp-ch" onclick="tc('+ci+')">';
    o+='<div class="gp-ch-left"><span class="gp-ch-arrow">&#9654;</span><span class="gp-ch-name">'+cat+'</span></div>';
    o+='<div class="gp-ch-right"><span class="gp-badge '+worst+'">'+(worst==='r'?'CRIT':worst==='y'?'ELEV':'OK')+'</span><span class="gp-ch-count">'+arr.length+'</span></div>';
    o+='</div>';

    // Business insight (always visible even when collapsed)
    o+='<div class="gp-insight">'+insight(cat,arr)+'</div>';

    // Expandable detail body
    o+='<div class="gp-body">';

    arr.forEach(({m,a})=>{
      let bt='';
      if(a.br.br) bt='<span class="gp-bt br">!</span>';
      else if(a.br.pr&&a.br.pr<=5) bt='<span class="gp-bt im">'+a.br.pr+'p</span>';
      else if(a.br.pr&&a.br.pr<=15) bt='<span class="gp-bt pj">'+a.br.pr+'p</span>';

      o+='<div class="gp-row">';
      o+='<div class="gp-rd '+a.rk+'"></div>';
      o+='<div class="gp-rn">'+m.sh+bt+'</div>';
      o+='<div class="gp-rv '+a.rk+'">'+fv(m)+'</div>';
      o+='<div class="gp-sp">'+spark(m.h,a.rk)+'</div>';
      o+='</div>';
    });

    // Category-level action
    const act=catAct(cat,arr);
    if(act){
      o+='<div class="gp-bact"><span class="gp-urg '+act.u+'">'+(act.u==='urgent'?'ACT NOW':'REVIEW')+'</span>'+act.t+'</div>';
    }

    o+='</div>'; // body
    o+='</div>'; // cat
  });

  // Footer
  o+='<div class="gp-foot">';
  o+='<div class="gp-tags"><span class="gp-tag a">D</span><span class="gp-tag b">Dx</span><span class="gp-tag c">P</span><span class="gp-tag d">Rx</span></div>';
  o+='<span>'+M.length+' metrics · 4-tier</span>';
  o+='</div>';

  p.innerHTML=o;
}

function tc(i){
  const el=document.querySelector('.gp-cat[data-c="'+i+'"]');
  if(el) el.classList.toggle('open');
}

render();
</script>
</body>
</html>
