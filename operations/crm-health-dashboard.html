<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Health — Synthetic Monitoring</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --white: #ffffff;
            --bg: #f8f9fa;
            --surface: #ffffff;
            --border: #dadce0;
            --border-lt: #e8eaed;
            --hover: #f1f3f4;
            --t1: #202124;
            --t2: #5f6368;
            --t3: #80868b;
            --blue: #1a73e8;
            --blue-bg: #e8f0fe;
            --blue-t: #174ea6;
            --green: #1e8e3e;
            --green-bg: #e6f4ea;
            --green-t: #137333;
            --red: #d93025;
            --red-bg: #fce8e6;
            --red-t: #a50e0e;
            --yellow: #e8710a;
            --yellow-bg: #fef7e0;
            --yellow-t: #b05a00;
            --purple: #9334e6;
            --purple-bg: #f3e8fd;
            --radius: 8px;
        }

        body {
            font-family: 'Inter', 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--t1);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* ─── TOPBAR ─── */
        .topbar {
            background: var(--white);
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        .topbar-logo {
            width: 28px; height: 28px; border-radius: 6px;
            background: var(--blue);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 12px;
        }
        .topbar-title { font-size: 14px; font-weight: 600; color: var(--t1); }
        .topbar-title span { color: var(--t3); font-weight: 400; margin-left: 6px; }
        .breadcrumb { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--t3); margin-left: 16px; }
        .breadcrumb a { color: var(--blue); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .topbar-right { display: flex; align-items: center; gap: 12px; }
        .live-dot {
            display: flex; align-items: center; gap: 5px;
            font-size: 11px; font-weight: 600; color: var(--green);
        }
        .live-dot::before {
            content: ''; width: 6px; height: 6px; border-radius: 50%;
            background: var(--green); animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
        .clock { font-size: 12px; color: var(--t3); }
        .tb-btn {
            font-family: inherit; font-size: 12px; font-weight: 500;
            padding: 6px 14px; border-radius: 6px; cursor: pointer;
            border: 1px solid var(--border); background: var(--white); color: var(--t1);
            display: flex; align-items: center; gap: 5px; transition: background .15s;
        }
        .tb-btn:hover { background: var(--hover); }
        .tb-btn.primary { background: var(--blue); border-color: var(--blue); color: #fff; }
        .tb-btn.primary:hover { background: #1765cc; }

        /* ─── PAGE HEADER ─── */
        .page-header {
            background: var(--white);
            border-bottom: 1px solid var(--border);
            padding: 20px 24px;
        }
        .ph-row { display: flex; justify-content: space-between; align-items: flex-start; }
        .ph-h1 { font-size: 22px; font-weight: 700; color: var(--t1); letter-spacing: -.3px; }
        .ph-sub { font-size: 13px; color: var(--t3); margin-top: 4px; }
        .ph-actions { display: flex; gap: 6px; }
        .range-btn {
            font-family: inherit; font-size: 12px; font-weight: 500;
            padding: 5px 14px; border-radius: 16px; cursor: pointer;
            border: 1px solid var(--border); background: var(--white); color: var(--t2);
            transition: all .15s;
        }
        .range-btn:hover { background: var(--hover); }
        .range-btn.on { background: var(--blue-bg); color: var(--blue-t); border-color: var(--blue-bg); font-weight: 600; }

        /* ─── KPI DOCK ─── */
        .kpi-dock {
            display: flex;
            justify-content: center;
            padding: 20px 24px 0;
        }
        .kpi-strip {
            display: flex;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(60,64,67,.08), 0 4px 12px rgba(60,64,67,.06);
            max-width: 1100px;
            width: 100%;
        }
        .kpi {
            flex: 1;
            padding: 14px 18px;
            display: flex; flex-direction: column; gap: 2px;
            border-right: 1px solid var(--border-lt);
            text-align: center;
            align-items: center;
        }
        .kpi:last-child { border-right: none; }
        .kpi-label {
            font-size: 10px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .4px;
        }
        .kpi-row { display: flex; align-items: flex-end; gap: 8px; }
        .kpi-val { font-size: 24px; font-weight: 700; line-height: 1.1; color: var(--t1); }
        .kpi-unit { font-size: 12px; font-weight: 500; color: var(--t3); }
        .kpi-spark { width: 44px; height: 18px; }
        .kpi-spark polyline { fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }
        .kpi-delta { font-size: 10px; font-weight: 500; display: flex; align-items: center; gap: 3px; margin-top: 2px; }
        .kpi-delta.up { color: var(--green); }
        .kpi-delta.dn { color: var(--red); }
        .kpi-delta.flat { color: var(--t3); }

        /* ─── CONTAINER ─── */
        .container { max-width: 1640px; margin: 0 auto; padding: 16px 24px 40px; }

        /* ─── SECTION TITLE ─── */
        .sec-title {
            font-size: 11px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .5px;
            margin: 20px 0 8px;
        }

        /* ─── CARD ─── */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
        }
        .card-hd {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-lt);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-t { font-size: 13px; font-weight: 600; color: var(--t1); display: flex; align-items: center; gap: 7px; }
        .card-t i { font-size: 12px; color: var(--t3); }
        .card-bd { padding: 16px; }

        /* ─── CHIPS ─── */
        .chip {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;
        }
        .chip.g { background: var(--green-bg); color: var(--green-t); }
        .chip.r { background: var(--red-bg); color: var(--red-t); }
        .chip.y { background: var(--yellow-bg); color: var(--yellow-t); }
        .chip.b { background: var(--blue-bg); color: var(--blue-t); }
        .chip i { font-size: 4px; }

        /* ─── STATUS DOT ─── */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
        .status-dot.g { background: var(--green); }
        .status-dot.y { background: var(--yellow); }
        .status-dot.r { background: var(--red); }

        /* ─── MZ TABLE (expandable) ─── */
        .mz-tbl { width: 100%; border-collapse: collapse; }
        .mz-tbl th {
            font-size: 11px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .3px;
            padding: 10px 16px; text-align: left;
            background: var(--bg); border-bottom: 1px solid var(--border);
        }
        .mz-tbl td {
            padding: 12px 16px; font-size: 13px; color: var(--t1);
            border-bottom: 1px solid var(--border-lt);
            vertical-align: middle;
        }
        .mz-row { cursor: pointer; transition: background .1s; }
        .mz-row:hover td { background: var(--hover); }
        .mz-row.expanded td { background: #f8f9fa; border-bottom-color: transparent; }
        .mz-name { display: flex; align-items: center; gap: 10px; }
        .mz-chevron {
            font-size: 9px; color: var(--t3); transition: transform .2s;
            width: 16px; text-align: center; flex-shrink: 0;
        }
        .mz-row.expanded .mz-chevron { transform: rotate(90deg); }
        .mz-icon {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px;
        }
        .mz-icon.g { background: var(--green-bg); color: var(--green); }
        .mz-icon.y { background: var(--yellow-bg); color: var(--yellow); }
        .mz-icon.r { background: var(--red-bg); color: var(--red); }
        .mz-nm { font-size: 13px; font-weight: 600; color: var(--t1); }
        .mz-sub { font-size: 11px; color: var(--t3); margin-top: 1px; }
        .ent-tags { display: flex; gap: 4px; }
        .ent-tag {
            padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
            background: var(--bg); color: var(--t2); border: 1px solid var(--border-lt);
        }
        .mono { font-family: 'Roboto Mono', 'SF Mono', Consolas, monospace; font-size: 12px; font-weight: 600; }
        .mono.g { color: var(--green); } .mono.y { color: var(--yellow); } .mono.r { color: var(--red); }
        .tbl-spark { width: 48px; height: 18px; display: block; }
        .tbl-spark polyline { fill: none; stroke-width: 1.5; stroke-linecap: round; stroke-linejoin: round; }

        /* Expanded entity detail */
        .mz-detail-row td { padding: 0 !important; border-bottom: 1px solid var(--border-lt); background: #fafbfc; }
        .mz-detail-row.hidden { display: none; }
        .mz-detail { padding: 4px 16px 12px 74px; }
        .mz-detail-hd {
            font-size: 10px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .4px;
            padding: 6px 0 4px; display: flex; align-items: center; gap: 5px;
        }
        .ent-type-group {
            margin-bottom: 4px;
        }
        /* Sub-pagination for entity detail */
        .ent-pag {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 10px 4px; margin-top: 4px;
            border-top: 1px solid var(--border-lt);
        }
        .ent-pag-info {
            font-size: 11px; font-weight: 500; color: var(--t3);
        }
        .ent-pag-info b { color: var(--t1); font-weight: 600; }
        .ent-pag-btns { display: flex; gap: 4px; align-items: center; }
        .ent-pag-btn {
            font-family: inherit; font-size: 11px; font-weight: 500;
            padding: 4px 12px; border-radius: 14px; cursor: pointer;
            border: 1px solid var(--border); background: var(--white); color: var(--t2);
            display: flex; align-items: center; gap: 4px; transition: all .15s;
        }
        .ent-pag-btn:hover:not(:disabled) { background: var(--hover); }
        .ent-pag-btn:disabled { opacity: .4; cursor: default; }
        .ent-pag-btn.primary { background: var(--blue); color: var(--white); border-color: var(--blue); }
        .ent-pag-btn.primary:hover:not(:disabled) { background: #1765cc; }
        .ent-pag-num {
            font-size: 11px; color: var(--t3); font-weight: 500; padding: 0 4px;
        }
        .ent-type-hd {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 10px 4px; font-size: 10px; font-weight: 600;
            color: var(--t3); text-transform: uppercase; letter-spacing: .4px;
            cursor: pointer; user-select: none; border-radius: 4px;
            transition: background .1s;
        }
        .ent-type-hd:hover { background: var(--hover); }
        .ent-type-chevron {
            font-size: 7px; color: var(--t3); transition: transform .2s;
            width: 12px; text-align: center; flex-shrink: 0;
        }
        .ent-type-hd.open .ent-type-chevron { transform: rotate(90deg); }
        .ent-type-summary {
            display: flex; align-items: center; gap: 10px;
            margin-left: auto; padding-left: 12px;
            font-size: 10px; font-weight: 500; text-transform: none; letter-spacing: 0;
        }
        .ent-type-hd.open .ent-type-summary { display: none; }
        .etype-stat {
            display: inline-flex; align-items: center; gap: 3px;
            color: var(--t2); white-space: nowrap;
        }
        .etype-stat i { font-size: 7px; }
        .etype-stat b { font-weight: 700; }
        .etype-stat.g b { color: var(--green); }
        .etype-stat.y b { color: var(--yellow); }
        .etype-stat.r b { color: var(--red); }
        .etype-kv {
            display: inline-flex; align-items: center; gap: 3px;
            padding: 1px 8px; border-radius: 4px;
            background: var(--bg); border: 1px solid var(--border-lt);
            font-family: 'Roboto Mono','SF Mono',Consolas,monospace;
            font-size: 10px; font-weight: 600; color: var(--t1); white-space: nowrap;
        }
        .etype-kv.g { color: var(--green); }
        .etype-kv.y { color: var(--yellow); }
        .etype-kv.r { color: var(--red); }
        .etype-sep {
            width: 1px; height: 12px; background: var(--border-lt); flex-shrink: 0;
        }
        .ent-type-body { overflow: hidden; }
        .ent-type-body.collapsed { display: none; }

        /* Impacted Entities Panel */
        .impact-tbl { width: 100%; border-collapse: collapse; }
        .impact-tbl th {
            font-size: 10px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .3px;
            padding: 8px 12px; text-align: left;
            background: var(--bg); border-bottom: 1px solid var(--border);
        }
        .impact-tbl td {
            padding: 10px 12px; font-size: 12px; color: var(--t1);
            border-bottom: 1px solid var(--border-lt); vertical-align: middle;
        }
        .impact-tbl tbody tr:hover td { background: var(--hover); }
        .impact-zone { font-size: 11px; color: var(--t3); font-weight: 500; }
        .impact-metric-val { font-size: 12px; font-weight: 600; font-family: 'Roboto Mono','SF Mono',Consolas,monospace; }
        .impact-metric-val.r { color: var(--red); }
        .impact-metric-val.y { color: var(--yellow); }
        .impact-entity { display: flex; align-items: center; gap: 8px; }
        .impact-ts { font-size: 11px; color: var(--t2); white-space: nowrap; }
        .impact-ts i { font-size: 9px; color: var(--t3); margin-right: 3px; }
        .impact-problem {
            display: inline-flex; align-items: center; gap: 5px;
            font-size: 11px; font-weight: 500; color: var(--blue);
            text-decoration: none; cursor: pointer; max-width: 220px;
        }
        .impact-problem:hover { text-decoration: underline; }
        .impact-problem i { font-size: 9px; flex-shrink: 0; }
        .impact-problem-id {
            font-family: 'Roboto Mono','SF Mono',Consolas,monospace;
            font-size: 9px; color: var(--t3); font-weight: 400;
        }
        .impact-outage {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
            white-space: nowrap;
        }
        .impact-outage.high { background: var(--red-bg); color: var(--red-t); }
        .impact-outage.med { background: var(--yellow-bg); color: var(--yellow-t); }
        .impact-outage i { font-size: 8px; }
        .health-summary {
            display: flex; gap: 0; border-bottom: 1px solid var(--border-lt);
        }
        .health-stat {
            flex: 1; text-align: center; padding: 12px 8px;
            border-right: 1px solid var(--border-lt);
        }
        .health-stat:last-child { border-right: none; }
        .health-stat-val { font-size: 18px; font-weight: 700; line-height: 1.2; }
        .health-stat-label {
            font-size: 9px; font-weight: 600; color: var(--t3);
            text-transform: uppercase; letter-spacing: .3px; margin-top: 2px;
        }
        .ent-type-badge {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
        }
        .ent-type-badge.svc { background: var(--blue-bg); color: var(--blue-t); }
        .ent-type-badge.host { background: var(--purple-bg); color: var(--purple); }
        .ent-type-badge.db { background: var(--yellow-bg); color: var(--yellow-t); }
        .ent-type-badge.pg { background: #e8f5e9; color: #2e7d32; }
        .ent-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 5px 10px; border-radius: 6px; transition: background .1s;
        }
        .ent-row:hover { background: var(--hover); }
        .ent-row-left { display: flex; align-items: center; gap: 8px; }
        .ent-type-icon {
            width: 22px; height: 22px; border-radius: 5px;
            display: flex; align-items: center; justify-content: center; font-size: 9px;
        }
        .ent-type-icon.svc { background: var(--blue-bg); color: var(--blue); }
        .ent-type-icon.host { background: var(--purple-bg); color: var(--purple); }
        .ent-type-icon.db { background: var(--yellow-bg); color: var(--yellow); }
        .ent-type-icon.pg { background: #e8f5e9; color: #2e7d32; }
        .ent-row-name { font-size: 12px; font-weight: 500; color: var(--t1); }
        .ent-row-right { display: flex; align-items: center; gap: 12px; }
        .ent-metric {
            text-align: right; min-width: 62px; position: relative; cursor: default;
        }
        .ent-mv { font-size: 12px; font-weight: 600; color: var(--t1); line-height: 1.2; }
        .ent-ml { font-size: 9px; font-weight: 600; color: var(--t3); text-transform: uppercase; letter-spacing: .2px; line-height: 1.3; }
        .ent-mk {
            font-size: 10px; color: var(--t2); font-weight: 500;
            font-family: 'Roboto Mono','SF Mono',Consolas,monospace;
            background: var(--white); border: 1px solid var(--border);
            border-radius: 4px; padding: 4px 8px;
            position: absolute; bottom: calc(100% + 6px); right: 0;
            white-space: nowrap; z-index: 20;
            box-shadow: 0 2px 8px rgba(60,64,67,.15);
            pointer-events: none; opacity: 0; transition: opacity .15s;
        }
        .ent-mk::after {
            content: ''; position: absolute; top: 100%; right: 12px;
            border: 5px solid transparent; border-top-color: var(--border);
        }
        .ent-metric:hover .ent-mk { opacity: 1; }

        /* ─── PAGINATION ─── */
        .pag-bar {
            display: flex; align-items: center; justify-content: flex-end;
            padding: 8px 16px; border-top: 1px solid var(--border-lt);
            gap: 24px; font-size: 12px; color: var(--t2); user-select: none;
        }
        .pag-rpp { display: flex; align-items: center; gap: 6px; }
        .pag-rpp label { font-size: 12px; color: var(--t3); font-weight: 500; }
        .pag-rpp select {
            font-family: inherit; font-size: 12px; font-weight: 500;
            padding: 3px 8px; border-radius: 4px; border: 1px solid var(--border);
            background: var(--white); color: var(--t1); cursor: pointer;
            outline: none;
        }
        .pag-rpp select:focus { border-color: var(--blue); }
        .pag-info { font-size: 12px; color: var(--t2); font-weight: 500; white-space: nowrap; }
        .pag-btns { display: flex; gap: 4px; }
        .pag-btn {
            width: 32px; height: 32px; border-radius: 50%;
            border: none; background: transparent; color: var(--t2);
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; cursor: pointer; transition: background .15s;
        }
        .pag-btn:hover:not(:disabled) { background: var(--hover); }
        .pag-btn:disabled { color: var(--border); cursor: default; }

        /* ─── GRID LAYOUTS ─── */
        .grid-main { display: grid; grid-template-columns: 1fr 360px; gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* ─── CHART ─── */
        .chart-wrap { position: relative; width: 100%; }
        .chart-wrap canvas { width: 100% !important; display: block; }

        /* ─── LEADING INDICATORS ─── */
        .li-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .li-card {
            background: var(--white); border: 1px solid var(--border);
            border-radius: var(--radius); padding: 14px 16px;
            display: flex; flex-direction: column; gap: 8px;
            border-left: 3px solid transparent;
            transition: box-shadow .15s;
        }
        .li-card:hover { box-shadow: 0 1px 4px rgba(60,64,67,.1); }
        .li-card.g { border-left-color: var(--green); }
        .li-card.y { border-left-color: var(--yellow); }
        .li-card.r { border-left-color: var(--red); }
        .li-hd { display: flex; align-items: center; justify-content: space-between; }
        .li-nm { font-size: 11px; font-weight: 600; color: var(--t2); display: flex; align-items: center; gap: 6px; }
        .li-nm i { font-size: 10px; color: var(--t3); }
        .li-metric {
            font-size: 9px; font-weight: 500; color: var(--t3);
            font-family: 'Roboto Mono', 'SF Mono', Consolas, monospace;
            letter-spacing: -.2px; margin-top: -4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .li-val-row { display: flex; align-items: flex-end; gap: 6px; }
        .li-val {
            font-size: 22px; font-weight: 700; line-height: 1;
            font-family: 'Roboto Mono', 'SF Mono', Consolas, monospace;
        }
        .li-val.g { color: var(--green); } .li-val.y { color: var(--yellow); } .li-val.r { color: var(--red); }
        .li-unit { font-size: 11px; font-weight: 500; color: var(--t3); margin-bottom: 2px; }
        .li-gauge { height: 4px; background: var(--border-lt); border-radius: 2px; overflow: hidden; }
        .li-gauge-fill { height: 100%; border-radius: 2px; transition: width .3s; }
        .li-gauge-fill.g { background: var(--green); }
        .li-gauge-fill.y { background: var(--yellow); }
        .li-gauge-fill.r { background: var(--red); }
        .li-foot { display: flex; align-items: center; justify-content: space-between; }
        .li-trend { font-size: 10px; font-weight: 500; display: flex; align-items: center; gap: 3px; }
        .li-trend.up { color: var(--green); }
        .li-trend.dn { color: var(--red); }
        .li-trend.flat { color: var(--t3); }
        .li-thresh { font-size: 10px; color: var(--t3); }

        /* ─── ALERTS ─── */
        .alert-item {
            display: flex; gap: 10px; padding: 12px 16px;
            border-bottom: 1px solid var(--border-lt);
        }
        .alert-item:last-child { border-bottom: none; }
        .alert-item:hover { background: var(--hover); }
        .alert-icon {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; flex-shrink: 0;
        }
        .alert-icon.r { background: var(--red-bg); color: var(--red); }
        .alert-icon.y { background: var(--yellow-bg); color: var(--yellow); }
        .alert-body { flex: 1; min-width: 0; }
        .alert-title { font-size: 12px; font-weight: 600; color: var(--t1); line-height: 1.3; }
        .alert-meta { font-size: 11px; color: var(--t3); margin-top: 2px; }

        /* ─── RESPONSIVE ─── */
        @media (max-width: 1400px) { .grid-main { grid-template-columns: 1fr; } }
        @media (max-width: 1100px) {
            .kpi-strip { flex-wrap: wrap; border-radius: 12px; }
            .kpi { min-width: 140px; }
            .li-grid { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }
        @media (max-width: 700px) {
            .kpi { min-width: 120px; }
            .li-grid { grid-template-columns: 1fr; }
            .kpi-dock { padding: 12px 12px 0; }
        }
    </style>
</head>
<body>

<!-- ─── TOPBAR ─── -->
<nav class="topbar">
    <div class="topbar-left">
        <div class="topbar-logo"><i class="fas fa-database"></i></div>
        <div class="topbar-title">CRM Health Monitor<span>Synthetic Monitoring</span></div>
        <div class="breadcrumb">
            <i class="fas fa-chevron-right" style="font-size:8px"></i>
            <a href="#">Monitoring</a>
            <i class="fas fa-chevron-right" style="font-size:8px"></i>
            <span>Application Health</span>
        </div>
    </div>
    <div class="topbar-right">
        <div class="live-dot">Live</div>
        <span class="clock" id="clock">—</span>
        <button class="tb-btn"><i class="fas fa-download"></i> Export</button>
        <button class="tb-btn primary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</nav>

<!-- ─── PAGE HEADER ─── -->
<div class="page-header">
    <div class="ph-row">
        <div>
            <h1 class="ph-h1">CRM Application Health</h1>
            <p class="ph-sub">7 Management Zones · 142 Entities · Last updated just now</p>
        </div>
        <div class="ph-actions">
            <button class="range-btn">1H</button>
            <button class="range-btn">6H</button>
            <button class="range-btn on">24H</button>
            <button class="range-btn">7D</button>
            <button class="range-btn">30D</button>
        </div>
    </div>
</div>

<!-- ─── KPI DOCK ─── -->
<div class="kpi-dock">
    <div class="kpi-strip">
        <div class="kpi">
            <span class="kpi-label">Health</span>
            <div class="kpi-row">
                <div><span class="kpi-val">94.2</span><span class="kpi-unit">%</span></div>
                <svg class="kpi-spark" viewBox="0 0 44 18"><polyline points="0,12 6,10 13,9 19,10 25,7 31,6 37,5 44,5" stroke="#1e8e3e" /></svg>
            </div>
            <div class="kpi-delta up"><i class="fas fa-arrow-up" style="font-size:8px"></i> +1.2%</div>
        </div>
        <div class="kpi">
            <span class="kpi-label">Zones</span>
            <div class="kpi-row"><div><span class="kpi-val">7</span></div></div>
            <div class="kpi-delta flat"><i class="fas fa-minus" style="font-size:8px"></i> All monitored</div>
        </div>
        <div class="kpi">
            <span class="kpi-label">Entities</span>
            <div class="kpi-row">
                <div><span class="kpi-val">142</span></div>
                <svg class="kpi-spark" viewBox="0 0 44 18"><polyline points="0,12 6,10 13,12 19,8 25,6 31,8 37,4 44,4" stroke="#1a73e8" /></svg>
            </div>
            <div class="kpi-delta up"><i class="fas fa-arrow-up" style="font-size:8px"></i> +4</div>
        </div>
        <div class="kpi">
            <span class="kpi-label">Avg Response</span>
            <div class="kpi-row">
                <div><span class="kpi-val">187</span><span class="kpi-unit">ms</span></div>
                <svg class="kpi-spark" viewBox="0 0 44 18"><polyline points="0,8 6,10 13,12 19,8 25,6 31,8 37,10 44,8" stroke="#1e8e3e" /></svg>
            </div>
            <div class="kpi-delta up"><i class="fas fa-arrow-down" style="font-size:8px"></i> SLA OK</div>
        </div>
        <div class="kpi">
            <span class="kpi-label">Alerts</span>
            <div class="kpi-row">
                <div><span class="kpi-val" style="color:var(--yellow)">3</span></div>
                <svg class="kpi-spark" viewBox="0 0 44 18"><polyline points="0,4 6,8 13,10 19,12 25,14 31,10 37,12 44,10" stroke="#e8710a" /></svg>
            </div>
            <div class="kpi-delta dn"><i class="fas fa-arrow-up" style="font-size:8px"></i> +1</div>
        </div>
        <div class="kpi">
            <span class="kpi-label">Uptime</span>
            <div class="kpi-row">
                <div><span class="kpi-val">99.87</span><span class="kpi-unit">%</span></div>
                <svg class="kpi-spark" viewBox="0 0 44 18"><polyline points="0,14 6,12 13,10 19,8 25,6 31,4 37,3 44,3" stroke="#1e8e3e" /></svg>
            </div>
            <div class="kpi-delta up"><i class="fas fa-arrow-up" style="font-size:8px"></i> +0.12%</div>
        </div>
    </div>
</div>

<div class="container">

    <!-- ─── MERGED: MZ TABLE + ENTITY BREAKDOWN ─── -->
    <div class="sec-title">Management Zones &amp; Entities</div>
    <div class="card" style="margin-bottom:12px;">
        <div class="card-hd">
            <div class="card-t"><i class="fas fa-th-large"></i> 7 Management Zones <span style="font-size:11px;color:var(--t3);font-weight:400;margin-left:4px;">· Click row to expand</span></div>
            <div style="display:flex;gap:4px;">
                <span class="chip g"><i class="fas fa-circle"></i> 5 Healthy</span>
                <span class="chip y"><i class="fas fa-circle"></i> 1 Warning</span>
                <span class="chip r"><i class="fas fa-circle"></i> 1 Critical</span>
            </div>
        </div>
        <div style="overflow-x:auto;">
            <table class="mz-tbl">
                <thead>
                    <tr><th>Zone</th><th>Status</th><th>Entities</th><th>Avg Latency</th><th>P95</th><th>Error Rate</th><th style="text-align:center">Trend</th></tr>
                </thead>
                <tbody id="mzBody"></tbody>
            </table>
        </div>
        <div class="pag-bar" id="mzPag">
            <div class="pag-rpp">
                <label>Rows per page:</label>
                <select id="pagSize">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                </select>
            </div>
            <div class="pag-info" id="pagInfo">1-7 of 7</div>
            <div class="pag-btns">
                <button class="pag-btn" id="pagFirst" title="First page"><i class="fas fa-angle-double-left"></i></button>
                <button class="pag-btn" id="pagPrev" title="Previous page"><i class="fas fa-angle-left"></i></button>
                <button class="pag-btn" id="pagNext" title="Next page"><i class="fas fa-angle-right"></i></button>
                <button class="pag-btn" id="pagLast" title="Last page"><i class="fas fa-angle-double-right"></i></button>
            </div>
        </div>
    </div>

    <!-- ─── CHART + ALERTS ─── -->
    <div class="sec-title">Performance</div>
    <div class="grid-main" style="margin-bottom:12px;">
        <div class="card">
            <div class="card-hd">
                <div class="card-t"><i class="fas fa-chart-line"></i> Latency Trends — 24h</div>
            </div>
            <div class="card-bd">
                <div class="chart-wrap" style="height:280px;"><canvas id="chartLatency"></canvas></div>
            </div>
        </div>
        <div>
            <div class="card">
                <div class="card-hd">
                    <div class="card-t"><i class="fas fa-bell"></i> Active Alerts</div>
                    <span class="chip r"><i class="fas fa-circle"></i> 3</span>
                </div>
                <div>
                    <div class="alert-item">
                        <div class="alert-icon r"><i class="fas fa-exclamation-circle"></i></div>
                        <div class="alert-body">
                            <div class="alert-title">High latency on CRM-Reporting-Engine</div>
                            <div class="alert-meta">report-generator-svc · 12 min ago</div>
                        </div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-icon y"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="alert-body">
                            <div class="alert-title">Database connection pool near capacity</div>
                            <div class="alert-meta">reporting-db-primary · 28 min ago</div>
                        </div>
                    </div>
                    <div class="alert-item">
                        <div class="alert-icon y"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="alert-body">
                            <div class="alert-title">Elevated query times on SQL Server</div>
                            <div class="alert-meta">crm-sqlserver-primary · 45 min ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ─── LEADING INDICATORS ─── -->
    <div class="sec-title">Leading Indicators</div>
    <div class="li-grid" style="margin-bottom:12px;" id="liGrid"></div>

    <!-- ─── ERROR RATE + THROUGHPUT ─── -->
    <div class="sec-title">Infrastructure Signals</div>
    <div class="grid-2">
        <div class="card">
            <div class="card-hd"><div class="card-t"><i class="fas fa-bug"></i> Error Rate by Zone</div></div>
            <div class="card-bd"><div class="chart-wrap" style="height:200px;"><canvas id="chartError"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-hd"><div class="card-t"><i class="fas fa-tachometer-alt"></i> Throughput by Zone</div></div>
            <div class="card-bd"><div class="chart-wrap" style="height:200px;"><canvas id="chartThroughput"></canvas></div></div>
        </div>
    </div>

    <!-- ─── IMPACTED ENTITIES & APP HEALTH ─── -->
    <div class="sec-title">Impacted Entities & Application Health</div>
    <div class="grid-main" style="margin-bottom:12px;">
        <div class="card">
            <div class="card-hd">
                <div class="card-t"><i class="fas fa-exclamation-circle"></i> Impacted Entities</div>
                <div style="display:flex;gap:4px;" id="impactChips"></div>
            </div>
            <div style="overflow-x:auto;">
                <table class="impact-tbl">
                    <thead><tr><th>Entity</th><th>Zone</th><th>Type</th><th>Status</th><th>Impacted Since</th><th>Problem</th><th>Key Metric</th><th>Outage</th><th style="text-align:center">Trend</th></tr></thead>
                    <tbody id="impactBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <div class="card-hd"><div class="card-t"><i class="fas fa-heartbeat"></i> Application Health — 24h</div></div>
            <div class="health-summary" id="healthSummary"></div>
            <div class="card-bd"><div class="chart-wrap" style="height:220px;"><canvas id="chartHealth"></canvas></div></div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    // ─── Clock ───
    function tick() {
        document.getElementById('clock').textContent = new Date().toLocaleString('en-US', {
            weekday:'short', month:'short', day:'numeric',
            hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
        });
    }
    tick(); setInterval(tick, 1000);

    // ─── Refresh ───
    document.getElementById('refreshBtn').addEventListener('click', function() {
        var b = this;
        b.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
        setTimeout(function() { b.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh'; }, 1200);
    });

    // ─── Range pills ───
    document.querySelectorAll('.range-btn').forEach(function(p) {
        p.addEventListener('click', function() {
            this.parentElement.querySelectorAll('.range-btn').forEach(function(x) { x.classList.remove('on'); });
            this.classList.add('on');
        });
    });

    // ─── SVG sparkline helper ───
    function svgSpark(data, color) {
        var w = 48, h = 18, pad = 2;
        var mn = Math.min.apply(null, data), mx = Math.max.apply(null, data);
        var range = mx - mn || 1;
        var pts = data.map(function(v, i) {
            var x = pad + (i / (data.length - 1)) * (w - pad * 2);
            var y = pad + (1 - (v - mn) / range) * (h - pad * 2);
            return x.toFixed(1) + ',' + y.toFixed(1);
        }).join(' ');
        return '<svg class="tbl-spark" viewBox="0 0 ' + w + ' ' + h + '"><polyline points="' + pts + '" stroke="' + color + '"/></svg>';
    }

    // ─── Entity data per zone ───
    // Entity types: svc=SERVICE, host=HOST, db=DATABASE (custom device), pg=PROCESS_GROUP_INSTANCE
    // Each entity carries 4 metrics with Dynatrace builtin: keys relevant to its type:
    //   SERVICE      → response.time, errors.total.rate, requestCount.total, keyRequests.errors.total.rate
    //   HOST         → cpu.usage, memory.usage, disk.queueLength, net.bytesTx
    //   DATABASE     → service.dbStatements (lock time, pool usage, query time, row count via custom)
    //   PROCESS_GROUP → mem.workingSetSize, cpu.usage (PGI), threads, suspensionTime
    var entMap = {
        'CRM-Core-Services': [
            { nm:'customer-service-api', type:'svc', st:'g', metrics:[
                {v:'124ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.08%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'4.2K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.02%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'account-management-svc', type:'svc', st:'g', metrics:[
                {v:'156ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.12%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'2.8K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.04%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'lead-scoring-engine', type:'svc', st:'g', metrics:[
                {v:'198ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.15%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'1.1K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.06%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'crm-core-node-01', type:'host', st:'g', metrics:[
                {v:'42%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'68%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'1.2',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'82MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]},
            { nm:'crm-core-node-02', type:'host', st:'g', metrics:[
                {v:'38%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'71%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'0.8',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'76MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]},
            { nm:'crm-core-svc.jar', type:'pg', st:'g', metrics:[
                {v:'1.8GB',l:'Heap Used',k:'builtin:tech.jvm.memory.pool.used'},
                {v:'14%',l:'PGI CPU',k:'builtin:tech.generic.cpu.usage'},
                {v:'248',l:'Threads',k:'builtin:tech.jvm.threads.count'},
                {v:'18ms',l:'GC Pause',k:'builtin:tech.jvm.memory.gc.suspensionTime'}
            ]}
        ],
        'CRM-API-Gateway': [
            { nm:'api-gateway-main', type:'svc', st:'g', metrics:[
                {v:'78ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.04%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'8.6K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.01%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'nginx-gateway', type:'pg', st:'g', metrics:[
                {v:'512MB',l:'Working Set',k:'builtin:tech.generic.mem.workingSetSize'},
                {v:'22%',l:'PGI CPU',k:'builtin:tech.generic.cpu.usage'},
                {v:'64',l:'Threads',k:'builtin:tech.generic.count.threads'},
                {v:'0ms',l:'GC Pause',k:'builtin:tech.jvm.memory.gc.suspensionTime'}
            ]}
        ],
        'CRM-Database-Cluster': [
            { nm:'crm-sqlserver-primary', type:'db', st:'y', metrics:[
                {v:'312ms',l:'Query Time',k:'builtin:service.response.time'},
                {v:'78%',l:'Pool Used',k:'builtin:service.dbStatements'},
                {v:'142ms',l:'Lock Wait',k:'builtin:service.lockTime'},
                {v:'18K/m',l:'Statements',k:'builtin:service.dbStatements'}
            ]},
            { nm:'crm-mongodb-cluster', type:'db', st:'g', metrics:[
                {v:'145ms',l:'Query Time',k:'builtin:service.response.time'},
                {v:'62%',l:'Pool Used',k:'builtin:service.dbStatements'},
                {v:'24ms',l:'Lock Wait',k:'builtin:service.lockTime'},
                {v:'12K/m',l:'Statements',k:'builtin:service.dbStatements'}
            ]},
            { nm:'db-cluster-host-01', type:'host', st:'y', metrics:[
                {v:'71%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'84%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'4.2',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'124MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]}
        ],
        'CRM-Integration-Hub': [
            { nm:'integration-orchestrator', type:'svc', st:'g', metrics:[
                {v:'198ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.15%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'860/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.08%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'partner-api-adapter', type:'svc', st:'g', metrics:[
                {v:'210ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.11%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'420/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.05%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'integration-worker.jar', type:'pg', st:'g', metrics:[
                {v:'2.1GB',l:'Heap Used',k:'builtin:tech.jvm.memory.pool.used'},
                {v:'18%',l:'PGI CPU',k:'builtin:tech.generic.cpu.usage'},
                {v:'186',l:'Threads',k:'builtin:tech.jvm.threads.count'},
                {v:'22ms',l:'GC Pause',k:'builtin:tech.jvm.memory.gc.suspensionTime'}
            ]}
        ],
        'CRM-Reporting-Engine': [
            { nm:'report-generator-svc', type:'svc', st:'r', metrics:[
                {v:'1.2s',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'3.2%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'320/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'4.8%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'analytics-aggregator', type:'svc', st:'r', metrics:[
                {v:'945ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'1.8%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'180/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'2.1%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'reporting-db-primary', type:'db', st:'y', metrics:[
                {v:'687ms',l:'Query Time',k:'builtin:service.response.time'},
                {v:'94%',l:'Pool Used',k:'builtin:service.dbStatements'},
                {v:'312ms',l:'Lock Wait',k:'builtin:service.lockTime'},
                {v:'6.4K/m',l:'Statements',k:'builtin:service.dbStatements'}
            ]},
            { nm:'report-node-01', type:'host', st:'r', metrics:[
                {v:'92%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'89%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'6.8',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'156MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]},
            { nm:'report-engine.jar', type:'pg', st:'r', metrics:[
                {v:'3.6GB',l:'Heap Used',k:'builtin:tech.jvm.memory.pool.used'},
                {v:'88%',l:'PGI CPU',k:'builtin:tech.generic.cpu.usage'},
                {v:'412',l:'Threads',k:'builtin:tech.jvm.threads.count'},
                {v:'145ms',l:'GC Pause',k:'builtin:tech.jvm.memory.gc.suspensionTime'}
            ]}
        ],
        'CRM-Auth-Services': [
            { nm:'oauth-token-service', type:'svc', st:'g', metrics:[
                {v:'67ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.05%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'5.6K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.01%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'auth-node-01', type:'host', st:'g', metrics:[
                {v:'28%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'52%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'0.4',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'34MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]}
        ],
        'CRM-Cache-Layer': [
            { nm:'redis-primary', type:'svc', st:'g', metrics:[
                {v:'12ms',l:'Resp Time',k:'builtin:service.response.time'},
                {v:'0.02%',l:'Failure',k:'builtin:service.errors.total.rate'},
                {v:'24K/m',l:'Throughput',k:'builtin:service.requestCount.total'},
                {v:'0.00%',l:'Key Req Err',k:'builtin:service.keyRequests.errors.total.rate'}
            ]},
            { nm:'cache-node-01', type:'host', st:'g', metrics:[
                {v:'18%',l:'CPU',k:'builtin:host.cpu.usage'},
                {v:'74%',l:'Memory',k:'builtin:host.mem.usage'},
                {v:'0.2',l:'Disk Queue',k:'builtin:host.disk.queueLength'},
                {v:'210MB/s',l:'Net Out',k:'builtin:host.net.bytesTx'}
            ]},
            { nm:'redis-server', type:'pg', st:'g', metrics:[
                {v:'6.2GB',l:'Working Set',k:'builtin:tech.generic.mem.workingSetSize'},
                {v:'16%',l:'PGI CPU',k:'builtin:tech.generic.cpu.usage'},
                {v:'12',l:'Threads',k:'builtin:tech.generic.count.threads'},
                {v:'0ms',l:'GC Pause',k:'builtin:tech.jvm.memory.gc.suspensionTime'}
            ]}
        ]
    };
    var typeIcons = { svc:'fa-cog', host:'fa-server', db:'fa-database', pg:'fa-cubes' };
    var typeLabels = { svc:'Service', host:'Host', db:'Database', pg:'Process Group' };

    // ─── Merged MZ + Entity Table ───
    var zones = [
        { nm:'CRM-Core-Services', sub:'Primary business logic', st:'g', icon:'fa-check-circle', ents:[{t:'svc',n:12},{t:'host',n:8},{t:'pg',n:6}], avg:'142ms', p95:'218ms', err:'0.12%', ac:'g', ec:'g', trend:[138,142,140,145,142,138,140,142], tc:'#1e8e3e' },
        { nm:'CRM-API-Gateway', sub:'External API endpoints', st:'g', icon:'fa-check-circle', ents:[{t:'svc',n:8},{t:'host',n:4},{t:'pg',n:3}], avg:'89ms', p95:'156ms', err:'0.08%', ac:'g', ec:'g', trend:[85,88,92,89,86,88,90,89], tc:'#1e8e3e' },
        { nm:'CRM-Database-Cluster', sub:'SQL & NoSQL databases', st:'y', icon:'fa-exclamation-circle', ents:[{t:'db',n:6},{t:'host',n:6}], avg:'287ms', p95:'412ms', err:'0.21%', ac:'y', ec:'g', trend:[265,278,295,302,298,285,290,287], tc:'#e8710a' },
        { nm:'CRM-Integration-Hub', sub:'Third-party integrations', st:'g', icon:'fa-check-circle', ents:[{t:'svc',n:15},{t:'host',n:5},{t:'pg',n:4}], avg:'198ms', p95:'342ms', err:'0.15%', ac:'g', ec:'g', trend:[185,192,198,205,198,195,200,198], tc:'#1e8e3e' },
        { nm:'CRM-Reporting-Engine', sub:'Analytics & reporting', st:'r', icon:'fa-times-circle', ents:[{t:'svc',n:9},{t:'host',n:4},{t:'db',n:2},{t:'pg',n:5}], avg:'892ms', p95:'1.4s', err:'2.34%', ac:'r', ec:'r', trend:[520,645,782,856,912,878,892,892], tc:'#d93025' },
        { nm:'CRM-Auth-Services', sub:'Auth & authorization', st:'g', icon:'fa-check-circle', ents:[{t:'svc',n:6},{t:'host',n:4},{t:'pg',n:3}], avg:'67ms', p95:'112ms', err:'0.05%', ac:'g', ec:'g', trend:[62,65,68,70,67,65,68,67], tc:'#1e8e3e' },
        { nm:'CRM-Cache-Layer', sub:'Redis & Memcached', st:'g', icon:'fa-check-circle', ents:[{t:'svc',n:4},{t:'host',n:8},{t:'pg',n:2}], avg:'12ms', p95:'28ms', err:'0.02%', ac:'g', ec:'g', trend:[10,12,11,13,12,11,12,12], tc:'#1e8e3e' }
    ];
    var stMap = { g:'Healthy', y:'Warning', r:'Critical' };
    var tbody = document.getElementById('mzBody');

    // Reporting-Engine starts expanded
    var defaultOpen = { 'CRM-Reporting-Engine': true };

    zones.forEach(function(m, idx) {
        var isOpen = !!defaultOpen[m.nm];
        var tags = m.ents.map(function(e) {
            var tl = e.t === 'svc' ? 'Svc' : e.t === 'host' ? 'Host' : e.t === 'pg' ? 'PGI' : 'DB';
            return '<span class="ent-tag">' + e.n + ' ' + tl + '</span>';
        }).join('');

        // Summary row
        var tr = document.createElement('tr');
        tr.className = 'mz-row' + (isOpen ? ' expanded' : '');
        tr.setAttribute('data-idx', idx);
        tr.innerHTML =
            '<td><div class="mz-name">' +
            '<i class="fas fa-chevron-right mz-chevron"></i>' +
            '<div class="mz-icon ' + m.st + '"><i class="fas ' + m.icon + '"></i></div>' +
            '<div><div class="mz-nm">' + m.nm + '</div><div class="mz-sub">' + m.sub + '</div></div>' +
            '</div></td>' +
            '<td><span class="chip ' + m.st + '"><i class="fas fa-circle"></i> ' + stMap[m.st] + '</span></td>' +
            '<td><div class="ent-tags">' + tags + '</div></td>' +
            '<td><span class="mono ' + m.ac + '">' + m.avg + '</span></td>' +
            '<td><span class="mono ' + m.ac + '">' + m.p95 + '</span></td>' +
            '<td><span class="mono ' + m.ec + '">' + m.err + '</span></td>' +
            '<td style="text-align:center">' + svgSpark(m.trend, m.tc) + '</td>';
        tbody.appendChild(tr);

        // Detail row — paginated entity breakdown
        var detailTr = document.createElement('tr');
        detailTr.className = 'mz-detail-row' + (isOpen ? '' : ' hidden');
        detailTr.id = 'detail-' + idx;
        detailTr.innerHTML = '<td colspan="7"><div class="mz-detail"></div></td>';
        tbody.appendChild(detailTr);

        // IIFE to capture per-zone state
        (function(zIdx, mzData, detailRow) {
            var ENT_PAGE_SIZE = 5;
            var entities = entMap[mzData.nm] || [];
            var totalEnts = mzData.ents.reduce(function(s, e) { return s + e.n; }, 0);
            var typeOrder = ['svc','host','db','pg'];
            var entPage = 0;
            var totalPages = Math.max(1, Math.ceil(entities.length / ENT_PAGE_SIZE));

            function renderEntPage() {
                var start = entPage * ENT_PAGE_SIZE;
                var end = Math.min(start + ENT_PAGE_SIZE, entities.length);
                var slice = entities.slice(start, end);

                // Group current page slice by type
                var grouped = {};
                slice.forEach(function(e) {
                    if (!grouped[e.type]) grouped[e.type] = [];
                    grouped[e.type].push(e);
                });

                var html = '<div class="mz-detail-hd"><i class="fas fa-sitemap" style="font-size:9px"></i> ' +
                    totalEnts + ' entities' + (entities.length < totalEnts ? ' (showing sample)' : '') + '</div>';

                typeOrder.forEach(function(t) {
                    if (!grouped[t]) return;
                    var totalOfType = (mzData.ents.filter(function(x){return x.t===t;})[0] || {n: grouped[t].length}).n;
                    // Compute aggregate stats for this type on this page
                    var gCount = 0, yCount = 0, rCount = 0;
                    grouped[t].forEach(function(e) {
                        if (e.st === 'g') gCount++;
                        else if (e.st === 'y') yCount++;
                        else if (e.st === 'r') rCount++;
                    });
                    // Primary metric average (first metric of each entity)
                    var mVals = grouped[t].map(function(e) {
                        return parseFloat(e.metrics[0].v.replace(/[^0-9.]/g,'')) || 0;
                    });
                    var mAvg = (mVals.reduce(function(s,v){return s+v;},0) / mVals.length);
                    var mLabel = grouped[t][0].metrics[0].l;
                    var mUnit = grouped[t][0].metrics[0].v.replace(/[0-9.,]+/g,'').trim() || '';
                    var avgStr = mAvg >= 100 ? Math.round(mAvg).toLocaleString() : mAvg.toFixed(1);
                    var worstSt = rCount > 0 ? 'r' : yCount > 0 ? 'y' : 'g';
                    // Secondary metric average (second metric)
                    var m2Vals = grouped[t].map(function(e) {
                        return e.metrics[1] ? parseFloat(e.metrics[1].v.replace(/[^0-9.]/g,'')) || 0 : 0;
                    });
                    var m2Avg = (m2Vals.reduce(function(s,v){return s+v;},0) / m2Vals.length);
                    var m2Label = grouped[t][0].metrics[1] ? grouped[t][0].metrics[1].l : '';
                    var m2Unit = grouped[t][0].metrics[1] ? grouped[t][0].metrics[1].v.replace(/[0-9.,]+/g,'').trim() : '';
                    var avg2Str = m2Avg >= 100 ? Math.round(m2Avg).toLocaleString() : m2Avg.toFixed(1);

                    // Build summary strip
                    var sumHtml = '<div class="ent-type-summary">';
                    // Status counts
                    if (gCount) sumHtml += '<span class="etype-stat g"><i class="fas fa-circle"></i> <b>' + gCount + '</b> OK</span>';
                    if (yCount) sumHtml += '<span class="etype-stat y"><i class="fas fa-circle"></i> <b>' + yCount + '</b> Warn</span>';
                    if (rCount) sumHtml += '<span class="etype-stat r"><i class="fas fa-circle"></i> <b>' + rCount + '</b> Crit</span>';
                    sumHtml += '<span class="etype-sep"></span>';
                    // Key metrics
                    sumHtml += '<span class="etype-kv ' + worstSt + '">Avg ' + mLabel + ': ' + avgStr + mUnit + '</span>';
                    if (m2Label) sumHtml += '<span class="etype-kv ' + worstSt + '">Avg ' + m2Label + ': ' + avg2Str + m2Unit + '</span>';
                    sumHtml += '</div>';

                    html += '<div class="ent-type-group" data-type="' + t + '">' +
                        '<div class="ent-type-hd"><i class="fas fa-chevron-right ent-type-chevron"></i><span class="ent-type-badge ' + t + '"><i class="fas ' + typeIcons[t] + '"></i> ' + typeLabels[t] + '</span>' +
                        '<span style="font-weight:400;color:var(--t3);font-size:9px;">' + grouped[t].length + ' of ' + totalOfType + '</span>' +
                        sumHtml + '</div>' +
                        '<div class="ent-type-body collapsed">';
                    grouped[t].forEach(function(e) {
                        var clr = e.st === 'r' ? ' style="color:var(--red)"' : e.st === 'y' ? ' style="color:var(--yellow)"' : '';
                        var mHtml = '';
                        e.metrics.forEach(function(mt) {
                            mHtml += '<div class="ent-metric"><div class="ent-mv"' + clr + '>' + mt.v + '</div><div class="ent-ml">' + mt.l + '</div><div class="ent-mk">' + mt.k + '</div></div>';
                        });
                        html += '<div class="ent-row">' +
                            '<div class="ent-row-left"><div class="ent-type-icon ' + e.type + '"><i class="fas ' + typeIcons[e.type] + '"></i></div>' +
                            '<span class="ent-row-name">' + e.nm + '</span></div>' +
                            '<div class="ent-row-right">' + mHtml +
                            '<span class="status-dot ' + e.st + '"></span>' +
                            '</div></div>';
                    });
                    html += '</div></div>';
                });

                // Sub-pagination bar
                if (totalPages > 1) {
                    html += '<div class="ent-pag">' +
                        '<div class="ent-pag-info">Showing <b>' + (start + 1) + '–' + end + '</b> of ' + entities.length + ' sampled entities</div>' +
                        '<div class="ent-pag-btns">' +
                        '<button class="ent-pag-btn ent-prev" ' + (entPage === 0 ? 'disabled' : '') + '><i class="fas fa-chevron-left" style="font-size:8px"></i> Prev</button>' +
                        '<span class="ent-pag-num">' + (entPage + 1) + ' / ' + totalPages + '</span>' +
                        '<button class="ent-pag-btn primary ent-next" ' + (entPage >= totalPages - 1 ? 'disabled' : '') + '>Next <i class="fas fa-chevron-right" style="font-size:8px"></i></button>' +
                        '</div></div>';
                }

                var container = detailRow.querySelector('.mz-detail');
                container.innerHTML = html;

                // Bind sub-pagination buttons
                var prevBtn = container.querySelector('.ent-prev');
                var nextBtn = container.querySelector('.ent-next');
                if (prevBtn) prevBtn.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    if (entPage > 0) { entPage--; renderEntPage(); }
                });
                if (nextBtn) nextBtn.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    if (entPage < totalPages - 1) { entPage++; renderEntPage(); }
                });

                // Bind type-level collapse toggles
                container.querySelectorAll('.ent-type-hd').forEach(function(hd) {
                    hd.addEventListener('click', function(ev) {
                        ev.stopPropagation();
                        var body = hd.nextElementSibling;
                        var isOpen = hd.classList.contains('open');
                        if (isOpen) {
                            hd.classList.remove('open');
                            body.classList.add('collapsed');
                        } else {
                            hd.classList.add('open');
                            body.classList.remove('collapsed');
                        }
                    });
                });
            }

            // Store renderer so toggle can reset to page 0
            detailRow._renderEntPage = function() { entPage = 0; renderEntPage(); };
            renderEntPage();
        })(idx, m, detailTr);

        // Toggle
        tr.addEventListener('click', function() {
            var d = document.getElementById('detail-' + idx);
            var open = !d.classList.contains('hidden');
            if (open) { d.classList.add('hidden'); tr.classList.remove('expanded'); }
            else { d.classList.remove('hidden'); tr.classList.add('expanded'); d._renderEntPage(); }
        });
    });

    // ─── PAGINATION ───
    var pagState = { page: 0, size: 10 };
    var pagSize = document.getElementById('pagSize');
    var pagInfo = document.getElementById('pagInfo');
    var pagFirst = document.getElementById('pagFirst');
    var pagPrev = document.getElementById('pagPrev');
    var pagNext = document.getElementById('pagNext');
    var pagLast = document.getElementById('pagLast');

    function renderPage() {
        var total = zones.length;
        var size = pagState.size;
        var maxPage = Math.max(0, Math.ceil(total / size) - 1);
        if (pagState.page > maxPage) pagState.page = maxPage;
        var start = pagState.page * size;
        var end = Math.min(start + size, total);

        // Show/hide rows — each zone has a summary row and a detail row (2 TRs per zone)
        var rows = tbody.querySelectorAll('tr.mz-row');
        var details = tbody.querySelectorAll('tr.mz-detail-row');
        for (var i = 0; i < rows.length; i++) {
            var visible = (i >= start && i < end);
            rows[i].style.display = visible ? '' : 'none';
            if (details[i]) {
                // If not in page range, always hide. If in range, respect expanded state.
                if (!visible) {
                    details[i].style.display = 'none';
                } else {
                    details[i].style.display = details[i].classList.contains('hidden') ? 'none' : '';
                }
            }
        }

        pagInfo.textContent = (start + 1) + '\u2013' + end + ' of ' + total;
        pagFirst.disabled = pagState.page === 0;
        pagPrev.disabled = pagState.page === 0;
        pagNext.disabled = pagState.page >= maxPage;
        pagLast.disabled = pagState.page >= maxPage;
    }

    pagSize.addEventListener('change', function() {
        pagState.size = parseInt(this.value, 10);
        pagState.page = 0;
        renderPage();
    });
    pagFirst.addEventListener('click', function() { pagState.page = 0; renderPage(); });
    pagPrev.addEventListener('click', function() { if (pagState.page > 0) pagState.page--; renderPage(); });
    pagNext.addEventListener('click', function() { pagState.page++; renderPage(); });
    pagLast.addEventListener('click', function() {
        pagState.page = Math.max(0, Math.ceil(zones.length / pagState.size) - 1);
        renderPage();
    });

    // Also re-apply page visibility after toggling a detail row
    var origToggle = tbody.querySelectorAll('tr.mz-row');
    origToggle.forEach(function(row) {
        row.addEventListener('click', function() {
            // Small delay so the hidden class is toggled first
            setTimeout(renderPage, 10);
        });
    });

    renderPage();

    // ─── LEADING INDICATORS (all Dynatrace builtin: metrics) ───
    var liData = [
        { nm:'Failure Rate', metric:'builtin:service.errors.total.rate', icon:'fa-exclamation-triangle', val:'2.34', unit:'%', pct:78, st:'r', trend:'dn', arrow:'fa-arrow-up', delta:'+1.1% / 6h', thresh:'Threshold: 1.0%' },
        { nm:'Response Time P99', metric:'builtin:service.response.time', icon:'fa-stopwatch', val:'1,420', unit:'ms', pct:95, st:'r', trend:'dn', arrow:'fa-arrow-up', delta:'+380ms / 6h', thresh:'SLO: &lt;800ms' },
        { nm:'Host CPU Usage', metric:'builtin:host.cpu.usage', icon:'fa-microchip', val:'78', unit:'%', pct:92, st:'y', trend:'dn', arrow:'fa-arrow-up', delta:'+12% / 6h', thresh:'Threshold: 85%' },
        { nm:'GC Suspension Time', metric:'builtin:tech.jvm.memory.gc.suspensionTime', icon:'fa-hourglass-half', val:'145', unit:'ms', pct:72, st:'y', trend:'dn', arrow:'fa-arrow-up', delta:'+38ms / 6h', thresh:'Threshold: 200ms' },
        { nm:'Disk Queue Length', metric:'builtin:host.disk.queueLength', icon:'fa-hdd', val:'4.8', unit:'ops', pct:64, st:'y', trend:'dn', arrow:'fa-arrow-up', delta:'+1.2 / 6h', thresh:'Threshold: 8.0' },
        { nm:'Network Retransmissions', metric:'builtin:host.net.retransmissionRate', icon:'fa-network-wired', val:'0.8', unit:'%', pct:40, st:'g', trend:'flat', arrow:'fa-minus', delta:'Stable', thresh:'Threshold: 2.0%' },
        { nm:'Process Memory', metric:'builtin:tech.generic.mem.workingSetSize', icon:'fa-memory', val:'72', unit:'%', pct:72, st:'g', trend:'dn', arrow:'fa-arrow-up', delta:'+4% / 24h', thresh:'Threshold: 85%' },
        { nm:'Synthetic Availability', metric:'builtin:synthetic.browser.availability', icon:'fa-robot', val:'98.6', unit:'%', pct:98, st:'g', trend:'up', arrow:'fa-arrow-up', delta:'+0.3% / 24h', thresh:'SLO: 99.5%' }
    ];
    var liGrid = document.getElementById('liGrid');
    var stLabel = { g:'OK', y:'Watch', r:'Alert' };
    liData.forEach(function(li) {
        var d = document.createElement('div');
        d.className = 'li-card ' + li.st;
        d.innerHTML =
            '<div class="li-hd"><span class="li-nm"><i class="fas ' + li.icon + '"></i> ' + li.nm + '</span>' +
            '<span class="chip ' + li.st + '" style="font-size:10px;padding:1px 8px;"><i class="fas fa-circle"></i> ' + stLabel[li.st] + '</span></div>' +
            '<div class="li-metric">' + li.metric + '</div>' +
            '<div class="li-val-row"><span class="li-val ' + li.st + '">' + li.val + '</span><span class="li-unit">' + li.unit + '</span></div>' +
            '<div class="li-gauge"><div class="li-gauge-fill ' + li.st + '" style="width:' + li.pct + '%"></div></div>' +
            '<div class="li-foot"><span class="li-trend ' + li.trend + '"><i class="fas ' + li.arrow + '" style="font-size:8px"></i> ' + li.delta + '</span><span class="li-thresh">' + li.thresh + '</span></div>';
        liGrid.appendChild(d);
    });

    // ─── CHART.JS DEFAULTS ───
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.font.size = 11;
    Chart.defaults.plugins.legend.labels.usePointStyle = true;
    Chart.defaults.plugins.legend.labels.pointStyleWidth = 8;
    Chart.defaults.plugins.legend.labels.padding = 16;
    Chart.defaults.plugins.legend.labels.font = { size: 11, weight: '500' };
    var gridC = '#e8eaed', tickC = '#80868b';
    var ttip = {
        backgroundColor: '#fff', titleColor: '#202124', bodyColor: '#5f6368',
        borderColor: '#dadce0', borderWidth: 1, padding: 10, cornerRadius: 8,
        titleFont: { weight: '600' }, bodyFont: { size: 11 }
    };
    var hours = ['00:00','02:00','04:00','06:00','08:00','10:00','12:00','14:00','16:00','18:00','20:00','22:00'];

    new Chart(document.getElementById('chartLatency'), {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                { label:'Core-Services', data:[135,142,138,145,152,148,142,138,145,142,140,142], borderColor:'#1e8e3e', tension:.35, fill:false, borderWidth:2, pointRadius:0, pointHoverRadius:3 },
                { label:'API-Gateway', data:[82,88,85,92,95,89,85,88,92,89,86,89], borderColor:'#1a73e8', tension:.35, fill:false, borderWidth:2, pointRadius:0, pointHoverRadius:3 },
                { label:'Database-Cluster', data:[245,268,278,295,312,298,285,275,292,287,280,287], borderColor:'#e8710a', tension:.35, fill:false, borderWidth:2, pointRadius:0, pointHoverRadius:3 },
                { label:'Reporting-Engine', data:[420,485,512,678,824,912,945,892,856,912,878,892], borderColor:'#d93025', backgroundColor:'rgba(217,48,37,.04)', tension:.35, fill:true, borderWidth:2, pointRadius:0, pointHoverRadius:3 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: Object.assign({}, ttip, { callbacks: { label: function(c) { return c.dataset.label + ': ' + c.raw + 'ms'; } } })
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: tickC, font: { size: 10 } } },
                y: { grid: { color: gridC }, ticks: { color: tickC, callback: function(v) { return v + 'ms'; } }, beginAtZero: true }
            }
        }
    });

    new Chart(document.getElementById('chartError'), {
        type: 'bar',
        data: {
            labels: ['Core','API','DB Cluster','Integration','Reporting','Auth','Cache'],
            datasets: [{
                label: 'Error Rate',
                data: [0.12, 0.08, 0.21, 0.15, 2.34, 0.05, 0.02],
                backgroundColor: function(ctx) { return ctx.raw > 1 ? '#fce8e6' : ctx.raw > 0.15 ? '#fef7e0' : '#e6f4ea'; },
                borderColor: function(ctx) { return ctx.raw > 1 ? '#d93025' : ctx.raw > 0.15 ? '#e8710a' : '#1e8e3e'; },
                borderWidth: 1, borderRadius: 4, borderSkipped: false
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: Object.assign({}, ttip, { callbacks: { label: function(c) { return c.raw + '%'; } } }) },
            scales: {
                x: { grid: { display: false }, ticks: { color: tickC, font: { size: 10 } } },
                y: { grid: { color: gridC }, ticks: { color: tickC, callback: function(v) { return v + '%'; } }, beginAtZero: true }
            }
        }
    });

    new Chart(document.getElementById('chartThroughput'), {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                { label:'Core-Services', data:[2.4,2.1,1.8,2.2,2.8,3.1,3.4,3.2,2.9,2.8,2.5,2.2], borderColor:'#1e8e3e', tension:.35, borderWidth:2, fill:false, pointRadius:0, pointHoverRadius:3 },
                { label:'API-Gateway', data:[1.8,1.5,1.2,1.6,2.1,2.4,2.6,2.5,2.2,2.1,1.9,1.7], borderColor:'#1a73e8', tension:.35, borderWidth:2, fill:false, pointRadius:0, pointHoverRadius:3 },
                { label:'Cache-Layer', data:[5.2,4.8,4.2,4.9,5.8,6.2,6.5,6.3,5.9,5.6,5.3,5.0], borderColor:'#9334e6', tension:.35, borderWidth:2, fill:false, pointRadius:0, pointHoverRadius:3 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: Object.assign({}, ttip, { callbacks: { label: function(c) { return c.dataset.label + ': ' + c.raw + 'K/min'; } } })
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: tickC, font: { size: 10 } } },
                y: { grid: { color: gridC }, ticks: { color: tickC, font: { size: 10 }, callback: function(v) { return v + 'K'; } }, beginAtZero: true }
            }
        }
    });

    // ─── IMPACTED ENTITIES ───
    var impactBody = document.getElementById('impactBody');
    var impactChips = document.getElementById('impactChips');
    // Problem & impact metadata keyed by entity name
    var impactMeta = {
        'report-generator-svc':   { since:'2026-02-06 08:12', pid:'P-2402186', problem:'High failure rate detected on report-generator-svc', outage:'3h 48m' },
        'analytics-aggregator':   { since:'2026-02-06 09:34', pid:'P-2402186', problem:'High failure rate detected on report-generator-svc', outage:'2h 26m' },
        'reporting-db-primary':   { since:'2026-02-06 07:45', pid:'P-2402191', problem:'Connection pool saturation on reporting-db-primary', outage:'4h 15m' },
        'report-node-01':         { since:'2026-02-06 08:02', pid:'P-2402186', problem:'CPU saturation causing cascading service degradation', outage:'3h 58m' },
        'report-engine.jar':      { since:'2026-02-06 08:18', pid:'P-2402193', problem:'JVM heap exhaustion and excessive GC pauses', outage:'3h 42m' },
        'crm-sqlserver-primary':  { since:'2026-02-06 10:22', pid:'P-2402198', problem:'Elevated query response time on SQL Server', outage:'1h 38m' },
        'db-cluster-host-01':     { since:'2026-02-06 10:45', pid:'P-2402198', problem:'Elevated query response time on SQL Server', outage:'1h 15m' }
    };

    var impactedEntities = [];
    Object.keys(entMap).forEach(function(zone) {
        entMap[zone].forEach(function(e) {
            if (e.st === 'r' || e.st === 'y') {
                var meta = impactMeta[e.nm] || { since:'\u2014', pid:'\u2014', problem:'Under investigation', outage:'\u2014' };
                impactedEntities.push({ nm: e.nm, zone: zone, type: e.type, st: e.st, metrics: e.metrics, since: meta.since, pid: meta.pid, problem: meta.problem, outage: meta.outage });
            }
        });
    });
    impactedEntities.sort(function(a, b) { return a.st === b.st ? 0 : a.st === 'r' ? -1 : 1; });

    var critCount = impactedEntities.filter(function(e) { return e.st === 'r'; }).length;
    var warnCount = impactedEntities.filter(function(e) { return e.st === 'y'; }).length;
    impactChips.innerHTML =
        '<span class="chip r"><i class="fas fa-circle"></i> ' + critCount + ' Critical</span>' +
        '<span class="chip y"><i class="fas fa-circle"></i> ' + warnCount + ' Warning</span>';

    // Trend sparklines per severity
    var sparkR = [30,45,62,78,85,90,88,92];
    var sparkY = [50,55,58,62,60,64,62,65];

    // Outage severity: >=2h = high, else med
    function outageClass(o) {
        if (o === '\u2014') return 'med';
        var parts = o.match(/(\d+)h/);
        return (parts && parseInt(parts[1], 10) >= 2) ? 'high' : 'med';
    }

    impactedEntities.forEach(function(e) {
        var tr = document.createElement('tr');
        var km = e.metrics[0];
        var oCls = outageClass(e.outage);
        tr.innerHTML =
            '<td><div class="impact-entity">' +
                '<div class="ent-type-icon ' + e.type + '"><i class="fas ' + typeIcons[e.type] + '"></i></div>' +
                '<span style="font-weight:600">' + e.nm + '</span></div></td>' +
            '<td><span class="impact-zone">' + e.zone.replace('CRM-','') + '</span></td>' +
            '<td><span class="ent-type-badge ' + e.type + '" style="font-size:9px;"><i class="fas ' + typeIcons[e.type] + '"></i> ' + typeLabels[e.type] + '</span></td>' +
            '<td><span class="chip ' + e.st + '"><i class="fas fa-circle"></i> ' + stMap[e.st] + '</span></td>' +
            '<td><span class="impact-ts"><i class="fas fa-clock"></i>' + e.since + '</span></td>' +
            '<td><a class="impact-problem" title="' + e.pid + ': ' + e.problem + '"><i class="fas fa-bolt"></i><span>' + e.problem + '</span></a>' +
                '<div class="impact-problem-id">' + e.pid + '</div></td>' +
            '<td><span class="impact-metric-val ' + e.st + '">' + km.v + '</span>' +
                '<span style="font-size:10px;color:var(--t3);margin-left:4px;">' + km.l + '</span></td>' +
            '<td><span class="impact-outage ' + oCls + '"><i class="fas fa-stopwatch"></i> ' + e.outage + '</span></td>' +
            '<td style="text-align:center">' + svgSpark(e.st === 'r' ? sparkR : sparkY, e.st === 'r' ? '#d93025' : '#e8710a') + '</td>';
        impactBody.appendChild(tr);
    });

    // ─── HEALTH SUMMARY STATS ───
    var healthSummary = document.getElementById('healthSummary');
    var totalEntities = 0, healthyCount = 0;
    Object.keys(entMap).forEach(function(zone) {
        entMap[zone].forEach(function(e) {
            totalEntities++;
            if (e.st === 'g') healthyCount++;
        });
    });
    var healthPct = ((healthyCount / totalEntities) * 100).toFixed(1);
    healthSummary.innerHTML =
        '<div class="health-stat"><div class="health-stat-val" style="color:var(--green)">' + healthPct + '%</div><div class="health-stat-label">Health</div></div>' +
        '<div class="health-stat"><div class="health-stat-val">' + totalEntities + '</div><div class="health-stat-label">Total</div></div>' +
        '<div class="health-stat"><div class="health-stat-val" style="color:var(--green)">' + healthyCount + '</div><div class="health-stat-label">Healthy</div></div>' +
        '<div class="health-stat"><div class="health-stat-val" style="color:var(--red)">' + critCount + '</div><div class="health-stat-label">Critical</div></div>' +
        '<div class="health-stat"><div class="health-stat-val" style="color:var(--yellow)">' + warnCount + '</div><div class="health-stat-label">Warning</div></div>';

    // ─── APP HEALTH TREND CHART ───
    new Chart(document.getElementById('chartHealth'), {
        type: 'line',
        data: {
            labels: hours,
            datasets: [
                {
                    label: 'Health Score',
                    data: [98.2, 97.8, 97.5, 96.2, 95.1, 94.8, 94.2, 93.8, 94.0, 94.2, 94.1, 94.2],
                    borderColor: '#1a73e8',
                    backgroundColor: 'rgba(26,115,232,.06)',
                    tension: .35, fill: true, borderWidth: 2,
                    pointRadius: 3, pointHoverRadius: 5,
                    pointBackgroundColor: function(ctx) {
                        return ctx.raw < 95 ? '#d93025' : ctx.raw < 97 ? '#e8710a' : '#1e8e3e';
                    }
                },
                {
                    label: 'SLO Target (95%)',
                    data: [95,95,95,95,95,95,95,95,95,95,95,95],
                    borderColor: '#d93025', borderDash: [6,3],
                    borderWidth: 1.5, fill: false, pointRadius: 0, pointHoverRadius: 0
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { position: 'bottom' },
                tooltip: Object.assign({}, ttip, { callbacks: { label: function(c) { return c.dataset.label + ': ' + c.raw + '%'; } } })
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: tickC, font: { size: 10 } } },
                y: {
                    grid: { color: gridC },
                    ticks: { color: tickC, callback: function(v) { return v + '%'; } },
                    min: 90, max: 100
                }
            }
        }
    });

})();
</script>
</body>
</html>
